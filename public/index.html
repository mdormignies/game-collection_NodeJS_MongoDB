<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Collection de Jeux</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Ma collection</h1>

    <form id="gameForm">
        <h2>Ajouter un jeu</h2>
        <input id="titre" name="titre" placeholder="Titre" type="text" required><br>

        <input id="genre" name="genre" placeholder="Genres (séparés par ,)" type="text" type="text"><br>
        <input id="plateforme" name="plateforme" placeholder="Plateformes (séparées par ,)" type="text"><br>

        <input id="editeur" name="editeur" placeholder="Éditeur" type="text"><br>
        <input id="developpeur" name="developpeur" placeholder="Développeur" type="text"><br>

        <input id="annee_sortie" name="annee_sortie" placeholder="Année" type="number"><br>
        <input id="metacritic_score" name="metacritic_score" placeholder="Metacritic" type="number"><br>
        <input id="temps_jeu_heures" name="temps_jeu_heures" placeholder="Temps de jeu" type="number"><br>

        <label>
            Terminé?
            <input id="termine" name="termine" type="checkbox">
        </label>

        <button type="submit">Ajouter</button>
    </form>

    <h2>Statistiques globales</h2>
    <div id="stats">
        Chargement...
    </div>

    <h2>Filtres</h2>

    <label>Genre :
        <input id="filterGenre" placeholder="RPG, Action, etc" type="text">
    </label>

    <label>Plateforme :
        <input id="filterPlateforme" placeholder="PC, PS5, etc" type="text">
    </label>

    <button id="applyFilters">Filtrer</button>
    <button id="clearFilters">Réinitialiser</button>


    <h2>Liste</h2>
    <label>Rechercher :
        <input id="searchInput" placeholder="Titre du jeu..." type="text">
    </label>
    <button id="exportBtn">Exporter les données</button>
    <ul id="gameList"></ul>

    <script>
        let allGames = []; // on garde tous les jeux pour filtrage côté client

        async function loadGames(filters = {}) {
            let url = '/api/games';

            const params = new URLSearchParams();

            if (filters.genre) params.append("genre", filters.genre);
            if (filters.plateforme) params.append("plateforme", filters.plateforme);

            if ([...params].length > 0) {
                url += "?" + params.toString();
            }

            const res = await fetch(url);
            allGames = await res.json(); // stocke la liste complète

            renderGameList(allGames);
        }

        function renderGameList(games) {
            const ul = document.getElementById('gameList');
            ul.innerHTML = '';
            games.forEach(g => {
                const li = document.createElement('li');

                // Créer le lien
                const a = document.createElement('a');
                a.href = `game.html?id=${g._id}`;
                a.textContent = g.titre;
                li.appendChild(a);

                // Ajouter l'étoile si favori
                const star = document.createElement('span');
                star.textContent = g.favoris ? '⭐' : '';
                li.appendChild(star);

                // Bouton favori
                const btn = document.createElement('button');
                btn.textContent = g.favoris ? "Retirer" : "Favori";
                li.appendChild(btn);

                // Événement pour basculer favori
                btn.addEventListener("click", async () => {
                    // Optimiste : inverser immédiatement l'état local
                    g.favoris = !g.favoris;
                    btn.textContent = g.favoris ? "Retirer" : "Favori";
                    star.textContent = g.favoris ? '⭐' : '';

                    // Envoyer la requête au serveur
                    const res = await fetch(`/api/games/${g._id}/favorite`, { method: "POST" });
                    if (!res.ok) {
                        alert("Erreur lors de la mise à jour du favori.");
                        // rollback si erreur
                        g.favoris = !g.favoris;
                        btn.textContent = g.favoris ? "Retirer" : "Favori";
                        star.textContent = g.favoris ? '⭐' : '';
                    }
                });

                ul.appendChild(li);
            });
        }

        async function loadStats() {
            const res = await fetch("/api/games/stats");
            const stats = await res.json();

            const div = document.getElementById("stats");

            div.innerHTML = `
                <p><strong>Nombre total de jeux :</strong> ${stats.total_jeux}</p>
                <p><strong>Temps de jeu total :</strong> ${stats.temps_total_heures} heures</p>
                <p><strong>Nombre de jeux terminés :</strong> ${stats.jeux_termines}</p>
                <p><strong>Metacritic moyen :</strong> ${stats.metacritic_moyen}</p>
            `;
        }

        document.getElementById("applyFilters").addEventListener("click", () => {
            const genre = document.getElementById("filterGenre").value.trim();
            const plateforme = document.getElementById("filterPlateforme").value.trim();

            loadGames({
                genre: genre || null,
                plateforme: plateforme || null
            });
        });

        document.getElementById("clearFilters").addEventListener("click", () => {
            document.getElementById("filterGenre").value = "";
            document.getElementById("filterPlateforme").value = "";
            loadGames();
        });

        document.getElementById('gameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                titre: document.getElementById('titre').value,
                genre: document.getElementById('genre').value,
                plateforme: document.getElementById('plateforme').value,
                editeur: document.getElementById('editeur').value,
                developpeur: document.getElementById('developpeur').value,
                annee_sortie: document.getElementById('annee_sortie').value,
                metacritic_score: document.getElementById('metacritic_score').value,
                temps_jeu_heures: document.getElementById('temps_jeu_heures').value,
                termine: document.getElementById('termine').checked
            };

            const res = await fetch('/api/games', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                const created = await res.json();
                console.log('Créé:', created);
                // reset du formulaire
                e.target.reset();
                loadGames();
            } else {
                const err = await res.json();
                alert('Erreur: ' + (err.error || JSON.stringify(err)));
            }
        });

        // Recherche dynamique
        document.getElementById('searchInput').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            const filtered = allGames.filter(g => g.titre.toLowerCase().includes(term));
            renderGameList(filtered);
        });

        document.getElementById("exportBtn").addEventListener("click", async () => {
            try {
                const res = await fetch("/api/games/export");
                if (!res.ok) throw new Error("Erreur lors de l'export");

                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "games.json";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (err) {
                alert(err.message);
            }
        });

        loadGames();
        loadStats();
    </script>
</body>

</html>